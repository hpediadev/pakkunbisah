#!/usr/bin/env node

const http = require('https');
const url = require('url');



function get({path, host}, callback) {
    http.get({
        path,
        host
    }, function(response) {
        if (response.headers.location) {
            var loc = response.headers.location;
            if (loc.match(/^http/)) {
                loc = new url.Url(loc);
                host = loc.host;
                path = loc.path;
            } else {
                path = loc;
            }
            get({host, path}, callback);
        } else {
            callback(response);
        }
    });
}

if (process.argv.length === 3) {
    get({
        host: 'unpkg.com',
        path: '/emoji-datasource-twitter/emoji.json'
    }, function(response) {
        // Continuously update stream with data
        var body = '';
        response.on('data', function(data) {
            body += data;
        });
        response.on('end', function() {
            var emoji = JSON.parse(body);
            console.log([
                '/*',
                ' * Autogenerated by mkemoji script from jQuery Terminal',
                ' * Copyright (C) Jakub T. Jankiewicz <https://jcubic.pl>',
                ' * ship with version: ' + process.argv[2],
                ' * build: ' + new Date().toUTCString(),
                ' */'].join('\n'));
            emoji.map(function(emoji) {
                var url = 'https://unpkg.com/emoji-datasource-twitter/img/' +
                    'twitter/64/' + emoji.image;
                // escape special characters in class name
                // https://mathiasbynens.be/notes/css-escapes
                var class_name = emoji.short_name.replace(/\+/g, '\\+')
                    .replace(/^(\d)/i, '\\3$1 ');
                var selector = [
                    '.terminal-output>:not(.raw) .emoji.' + class_name,
                    '.cmd .emoji.' + class_name].join(',');
                console.log(`${selector}{background-image:url(${url});}`);
            });
        });
    });
}
